<!DOCTYPE html><html lang="en"><head><title>12-ajax</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="12-ajax"><meta name="groc-project-path" content="jquery-1.6.2/12-ajax.js"><meta name="groc-github-url" content="https://github.com/nevir/jquery-annotated-source"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/nevir/jquery-annotated-source/blob/master/jquery-1.6.2/12-ajax.js">jquery-1.6.2/12-ajax.js</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p><strong>jQuery Annotated Source</strong>.</p></div></div><div class="code"><div class="wrapper"><span class="c1">//</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p><a href="/jquery-annotated-source/">Home</a> | <a href="11-css.html">Previous Chapter</a> | <a href="13-effects.html">Next Chapter</a></p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="ajax">AJAX</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">r20</span> <span class="o">=</span> <span class="sr">/%20/g</span><span class="p">,</span>
  <span class="nx">rbracket</span> <span class="o">=</span> <span class="sr">/\[\]$/</span><span class="p">,</span>
  <span class="nx">rCRLF</span> <span class="o">=</span> <span class="sr">/\r?\n/g</span><span class="p">,</span>
  <span class="nx">rhash</span> <span class="o">=</span> <span class="sr">/#.*$/</span><span class="p">,</span>
  <span class="nx">rheaders</span> <span class="o">=</span> <span class="sr">/^(.*?):[ \t]*([^\r\n]*)\r?$/mg</span><span class="p">,</span> <span class="c1">// IE leaves an \r character at EOL</span>
  <span class="nx">rinput</span> <span class="o">=</span> <span class="sr">/^(?:color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="7653-8125-8152-local-protocol-detection">7653, #8125, #8152: local protocol detection</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nx">rlocalProtocol</span> <span class="o">=</span> <span class="sr">/^(?:about|app|app\-storage|.+\-extension|file|widget):$/</span><span class="p">,</span>
  <span class="nx">rnoContent</span> <span class="o">=</span> <span class="sr">/^(?:GET|HEAD)$/</span><span class="p">,</span>
  <span class="nx">rprotocol</span> <span class="o">=</span> <span class="sr">/^\/\//</span><span class="p">,</span>
  <span class="nx">rquery</span> <span class="o">=</span> <span class="sr">/\?/</span><span class="p">,</span>
  <span class="nx">rscript</span> <span class="o">=</span> <span class="sr">/&lt;script\b[^&lt;]*(?:(?!&lt;\/script&gt;)&lt;[^&lt;]*)*&lt;\/script&gt;/gi</span><span class="p">,</span>
  <span class="nx">rselectTextarea</span> <span class="o">=</span> <span class="sr">/^(?:select|textarea)/i</span><span class="p">,</span>
  <span class="nx">rspacesAjax</span> <span class="o">=</span> <span class="sr">/\s+/</span><span class="p">,</span>
  <span class="nx">rts</span> <span class="o">=</span> <span class="sr">/([?&amp;])_=[^&amp;]*/</span><span class="p">,</span>
  <span class="nx">rurl</span> <span class="o">=</span> <span class="sr">/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Keep a copy of the old load method</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_load</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">load</span><span class="p">,</span>

  <span class="cm">/* Prefilters</span>
<span class="cm">   * 1) They are useful to introduce custom dataTypes (see ajax/jsonp.js for an example)</span>
<span class="cm">   * 2) These are called:</span>
<span class="cm">   *    - BEFORE asking for a transport</span>
<span class="cm">   *    - AFTER param serialization (s.data is a string if s.processData is true)</span>
<span class="cm">   * 3) key is the dataType</span>
<span class="cm">   * 4) the catchall symbol &quot;*&quot; can be used</span>
<span class="cm">   * 5) execution will start with transport dataType and THEN continue down to &quot;*&quot; if needed</span>
<span class="cm">   */</span>
  <span class="nx">prefilters</span> <span class="o">=</span> <span class="p">{},</span>

  <span class="cm">/* Transports bindings</span>
<span class="cm">   * 1) key is the dataType</span>
<span class="cm">   * 2) the catchall symbol &quot;*&quot; can be used</span>
<span class="cm">   * 3) selection will start with transport dataType and THEN go to &quot;*&quot; if needed</span>
<span class="cm">   */</span>
  <span class="nx">transports</span> <span class="o">=</span> <span class="p">{},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Document location</p></div></div><div class="code"><div class="wrapper">  <span class="nx">ajaxLocation</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Document location segments</p></div></div><div class="code"><div class="wrapper">  <span class="nx">ajaxLocParts</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="8138-ie-may-throw-an-exception-when-accessing">8138, IE may throw an exception when accessing</h1>

<p>a field from window.location if document.domain has been set</p></div></div><div class="code"><div class="wrapper"><span class="k">try</span> <span class="p">{</span>
  <span class="nx">ajaxLocation</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use the href attribute of an A element
since IE will modify it given document.location</p></div></div><div class="code"><div class="wrapper">  <span class="nx">ajaxLocation</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span> <span class="s2">&quot;a&quot;</span> <span class="p">);</span>
  <span class="nx">ajaxLocation</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="nx">ajaxLocation</span> <span class="o">=</span> <span class="nx">ajaxLocation</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Segment location into parts</p></div></div><div class="code"><div class="wrapper"><span class="nx">ajaxLocParts</span> <span class="o">=</span> <span class="nx">rurl</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">ajaxLocation</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="p">)</span> <span class="o">||</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Base "constructor" for jQuery.ajaxPrefilter and jQuery.ajaxTransport</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">addToPrefiltersOrTransports</span><span class="p">(</span> <span class="nx">structure</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>dataTypeExpression is optional and defaults to "*"</p></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">dataTypeExpression</span><span class="p">,</span> <span class="nx">func</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">dataTypeExpression</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">func</span> <span class="o">=</span> <span class="nx">dataTypeExpression</span><span class="p">;</span>
      <span class="nx">dataTypeExpression</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">func</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dataTypes</span> <span class="o">=</span> <span class="nx">dataTypeExpression</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span> <span class="nx">rspacesAjax</span> <span class="p">),</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">length</span> <span class="o">=</span> <span class="nx">dataTypes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">dataType</span><span class="p">,</span>
        <span class="nx">list</span><span class="p">,</span>
        <span class="nx">placeBefore</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For each dataType in the dataTypeExpression</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span><span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">dataType</span> <span class="o">=</span> <span class="nx">dataTypes</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We control if we're asked to add before
any existing element</p></div></div><div class="code"><div class="wrapper">        <span class="nx">placeBefore</span> <span class="o">=</span> <span class="sr">/^\+/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">dataType</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">placeBefore</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">dataType</span> <span class="o">=</span> <span class="nx">dataType</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">||</span> <span class="s2">&quot;*&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">list</span> <span class="o">=</span> <span class="nx">structure</span><span class="p">[</span> <span class="nx">dataType</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">structure</span><span class="p">[</span> <span class="nx">dataType</span> <span class="p">]</span> <span class="o">||</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>then we add to the structure accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="nx">list</span><span class="p">[</span> <span class="nx">placeBefore</span> <span class="o">?</span> <span class="s2">&quot;unshift&quot;</span> <span class="o">:</span> <span class="s2">&quot;push&quot;</span> <span class="p">](</span> <span class="nx">func</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Base inspection function for prefilters and transports</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">inspectPrefiltersOrTransports</span><span class="p">(</span> <span class="nx">structure</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">originalOptions</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">,</span>
    <span class="nx">dataType</span> <span class="cm">/* internal */</span><span class="p">,</span> <span class="nx">inspected</span> <span class="cm">/* internal */</span> <span class="p">)</span> <span class="p">{</span>

  <span class="nx">dataType</span> <span class="o">=</span> <span class="nx">dataType</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
  <span class="nx">inspected</span> <span class="o">=</span> <span class="nx">inspected</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="nx">inspected</span><span class="p">[</span> <span class="nx">dataType</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">list</span> <span class="o">=</span> <span class="nx">structure</span><span class="p">[</span> <span class="nx">dataType</span> <span class="p">],</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">length</span> <span class="o">=</span> <span class="nx">list</span> <span class="o">?</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">executeOnly</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">structure</span> <span class="o">===</span> <span class="nx">prefilters</span> <span class="p">),</span>
    <span class="nx">selection</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">executeOnly</span> <span class="o">||</span> <span class="o">!</span><span class="nx">selection</span> <span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">selection</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span> <span class="nx">i</span> <span class="p">](</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">originalOptions</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we got redirected to another dataType
we try there if executing only and not done already</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">selection</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">executeOnly</span> <span class="o">||</span> <span class="nx">inspected</span><span class="p">[</span> <span class="nx">selection</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">selection</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">options</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">selection</span> <span class="p">);</span>
        <span class="nx">selection</span> <span class="o">=</span> <span class="nx">inspectPrefiltersOrTransports</span><span class="p">(</span>
            <span class="nx">structure</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">originalOptions</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">selection</span><span class="p">,</span> <span class="nx">inspected</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we're only executing or nothing was selected
we try the catchall dataType if not done already</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">executeOnly</span> <span class="o">||</span> <span class="o">!</span><span class="nx">selection</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">inspected</span><span class="p">[</span> <span class="s2">&quot;*&quot;</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">selection</span> <span class="o">=</span> <span class="nx">inspectPrefiltersOrTransports</span><span class="p">(</span>
        <span class="nx">structure</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">originalOptions</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nx">inspected</span> <span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>unnecessary when only executing (prefilters)
but it'll be ignored by the caller in that case</p></div></div><div class="code"><div class="wrapper">  <span class="k">return</span> <span class="nx">selection</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">jQuery</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">url</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">_load</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_load</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Don't do a request if no elements are being requested</p></div></div><div class="code"><div class="wrapper">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">off</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">&quot; &quot;</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">off</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span> <span class="nx">off</span><span class="p">,</span> <span class="nx">url</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>
      <span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">off</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default to a GET request</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the second parameter was provided</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If it's a function</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">params</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We assume that it's the callback</p></div></div><div class="code"><div class="wrapper">        <span class="nx">callback</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span>
        <span class="nx">params</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Otherwise, build a param string</p></div></div><div class="code"><div class="wrapper">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">params</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">params</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">traditional</span> <span class="p">);</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Request the remote document</p></div></div><div class="code"><div class="wrapper">    <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">params</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Complete callback (responseText is used internally)</p></div></div><div class="code"><div class="wrapper">      <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">responseText</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Store the response as specified by the jqXHR object</p></div></div><div class="code"><div class="wrapper">        <span class="nx">responseText</span> <span class="o">=</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If successful, inject the HTML into all the matched elements</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">isResolved</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h1 id="4825-get-the-actual-response-in-case">4825: Get the actual response in case</h1>

<p>a dataFilter is present in ajaxSettings</p></div></div><div class="code"><div class="wrapper">          <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">r</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">responseText</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span>
          <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>See if a selector was specified</p></div></div><div class="code"><div class="wrapper">          <span class="nx">self</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span> <span class="nx">selector</span> <span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create a dummy div to hold the results</p></div></div><div class="code"><div class="wrapper">            <span class="nx">jQuery</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>inject the contents of the document in, removing the scripts
to avoid any 'Permission Denied' errors in IE</p></div></div><div class="code"><div class="wrapper">              <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rscript</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Locate the specified elements</p></div></div><div class="code"><div class="wrapper">              <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="o">:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If not, just inject the full result</p></div></div><div class="code"><div class="wrapper">            <span class="nx">responseText</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">callback</span><span class="p">,</span> <span class="p">[</span> <span class="nx">responseText</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">serialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">serializeArray</span><span class="p">()</span> <span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">serializeArray</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">elements</span> <span class="o">?</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">makeArray</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">elements</span> <span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">checked</span> <span class="o">||</span> <span class="nx">rselectTextarea</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">nodeName</span> <span class="p">)</span> <span class="o">||</span>
          <span class="nx">rinput</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">elem</span> <span class="p">){</span>
      <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span> <span class="k">this</span> <span class="p">).</span><span class="nx">val</span><span class="p">();</span>

      <span class="k">return</span> <span class="nx">val</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span>
        <span class="kc">null</span> <span class="o">:</span>
        <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">val</span> <span class="p">)</span> <span class="o">?</span>
          <span class="nx">jQuery</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">val</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">i</span> <span class="p">){</span>
            <span class="k">return</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">val</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">rCRLF</span><span class="p">,</span> <span class="s2">&quot;\r\n&quot;</span> <span class="p">)</span> <span class="p">};</span>
          <span class="p">})</span> <span class="o">:</span>
          <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">val</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">rCRLF</span><span class="p">,</span> <span class="s2">&quot;\r\n&quot;</span> <span class="p">)</span> <span class="p">};</span>
    <span class="p">}).</span><span class="nx">get</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Attach a bunch of functions for handling common AJAX events</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="s2">&quot;ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend&quot;</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="s2">&quot; &quot;</span> <span class="p">),</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">o</span> <span class="p">){</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">fn</span><span class="p">[</span> <span class="nx">o</span> <span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">f</span> <span class="p">){</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">f</span> <span class="p">);</span>
  <span class="p">};</span>
<span class="p">});</span>

<span class="nx">jQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="p">[</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span> <span class="p">],</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">method</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">jQuery</span><span class="p">[</span> <span class="nx">method</span> <span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>shift arguments if data argument was omitted</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">||</span> <span class="nx">callback</span><span class="p">;</span>
      <span class="nx">callback</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">method</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
      <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
      <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span>
      <span class="nx">dataType</span><span class="o">:</span> <span class="nx">type</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">});</span>

<span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>

  <span class="nx">getScript</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="s2">&quot;script&quot;</span> <span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">getJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span> <span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Creates a full fledged settings object into target
with both ajaxSettings and settings fields.
If target is omitted, writes into ajaxSettings.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">ajaxSetup</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">settings</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">settings</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Only one parameter, we extend ajaxSettings</p></div></div><div class="code"><div class="wrapper">      <span class="nx">settings</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
      <span class="nx">target</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">,</span> <span class="nx">settings</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>target was provided, we extend into it</p></div></div><div class="code"><div class="wrapper">      <span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">,</span> <span class="nx">settings</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Flatten fields we don't want deep extended</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">field</span> <span class="k">in</span> <span class="p">{</span> <span class="nx">context</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">field</span> <span class="k">in</span> <span class="nx">settings</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">target</span><span class="p">[</span> <span class="nx">field</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">[</span> <span class="nx">field</span> <span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="nx">field</span> <span class="k">in</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">target</span><span class="p">[</span> <span class="nx">field</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">[</span> <span class="nx">field</span> <span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="nx">ajaxSettings</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">ajaxLocation</span><span class="p">,</span>
    <span class="nx">isLocal</span><span class="o">:</span> <span class="nx">rlocalProtocol</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">ajaxLocParts</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">),</span>
    <span class="nx">global</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="nx">contentType</span><span class="o">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
    <span class="nx">processData</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">async</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="cm">/*</span>
<span class="cm">    timeout: 0,</span>
<span class="cm">    data: null,</span>
<span class="cm">    dataType: null,</span>
<span class="cm">    username: null,</span>
<span class="cm">    password: null,</span>
<span class="cm">    cache: null,</span>
<span class="cm">    traditional: false,</span>
<span class="cm">    headers: {},</span>
<span class="cm">    */</span>

    <span class="nx">accepts</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">xml</span><span class="o">:</span> <span class="s2">&quot;application/xml, text/xml&quot;</span><span class="p">,</span>
      <span class="nx">html</span><span class="o">:</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
      <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
      <span class="nx">json</span><span class="o">:</span> <span class="s2">&quot;application/json, text/javascript&quot;</span><span class="p">,</span>
      <span class="s2">&quot;*&quot;</span><span class="o">:</span> <span class="s2">&quot;*/*&quot;</span>
    <span class="p">},</span>

    <span class="nx">contents</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">xml</span><span class="o">:</span> <span class="sr">/xml/</span><span class="p">,</span>
      <span class="nx">html</span><span class="o">:</span> <span class="sr">/html/</span><span class="p">,</span>
      <span class="nx">json</span><span class="o">:</span> <span class="sr">/json/</span>
    <span class="p">},</span>

    <span class="nx">responseFields</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">xml</span><span class="o">:</span> <span class="s2">&quot;responseXML&quot;</span><span class="p">,</span>
      <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;responseText&quot;</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>List of data converters
1) key format is "source<em>type destination</em>type" (a single space in-between)
2) the catchall symbol "*" can be used for source_type</p></div></div><div class="code"><div class="wrapper">    <span class="nx">converters</span><span class="o">:</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Convert anything to text</p></div></div><div class="code"><div class="wrapper">      <span class="s2">&quot;* text&quot;</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nb">String</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Text to html (true = no transformation)</p></div></div><div class="code"><div class="wrapper">      <span class="s2">&quot;text html&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Evaluate text as a json expression</p></div></div><div class="code"><div class="wrapper">      <span class="s2">&quot;text json&quot;</span><span class="o">:</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Parse text as xml</p></div></div><div class="code"><div class="wrapper">      <span class="s2">&quot;text xml&quot;</span><span class="o">:</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">parseXML</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">ajaxPrefilter</span><span class="o">:</span> <span class="nx">addToPrefiltersOrTransports</span><span class="p">(</span> <span class="nx">prefilters</span> <span class="p">),</span>
  <span class="nx">ajaxTransport</span><span class="o">:</span> <span class="nx">addToPrefiltersOrTransports</span><span class="p">(</span> <span class="nx">transports</span> <span class="p">),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Main method</p></div></div><div class="code"><div class="wrapper">  <span class="nx">ajax</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">options</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If url is an object, simulate pre-1.5 signature</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">url</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
      <span class="nx">url</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Force options to be an object</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="kd">var</span> <span class="c1">// Create the final options object</span>
      <span class="nx">s</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">(</span> <span class="p">{},</span> <span class="nx">options</span> <span class="p">),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Callbacks context</p></div></div><div class="code"><div class="wrapper">      <span class="nx">callbackContext</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">context</span> <span class="o">||</span> <span class="nx">s</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Context for global events
It's the callbackContext if one was provided in the options
and if it's a DOM node or a jQuery collection</p></div></div><div class="code"><div class="wrapper">      <span class="nx">globalEventContext</span> <span class="o">=</span> <span class="nx">callbackContext</span> <span class="o">!==</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span> <span class="nx">callbackContext</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">||</span> <span class="nx">callbackContext</span> <span class="k">instanceof</span> <span class="nx">jQuery</span> <span class="p">)</span> <span class="o">?</span>
            <span class="nx">jQuery</span><span class="p">(</span> <span class="nx">callbackContext</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">event</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Deferreds</p></div></div><div class="code"><div class="wrapper">      <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">(),</span>
      <span class="nx">completeDeferred</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">_Deferred</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Status-dependent callbacks</p></div></div><div class="code"><div class="wrapper">      <span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="p">{},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>ifModified key</p></div></div><div class="code"><div class="wrapper">      <span class="nx">ifModifiedKey</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Headers (they are sent all at once)</p></div></div><div class="code"><div class="wrapper">      <span class="nx">requestHeaders</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">requestHeadersNames</span> <span class="o">=</span> <span class="p">{},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Response headers</p></div></div><div class="code"><div class="wrapper">      <span class="nx">responseHeadersString</span><span class="p">,</span>
      <span class="nx">responseHeaders</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>transport</p></div></div><div class="code"><div class="wrapper">      <span class="nx">transport</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>timeout handle</p></div></div><div class="code"><div class="wrapper">      <span class="nx">timeoutTimer</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cross-domain detection vars</p></div></div><div class="code"><div class="wrapper">      <span class="nx">parts</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The jqXHR state</p></div></div><div class="code"><div class="wrapper">      <span class="nx">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To know if global events are to be dispatched</p></div></div><div class="code"><div class="wrapper">      <span class="nx">fireGlobals</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Loop variable</p></div></div><div class="code"><div class="wrapper">      <span class="nx">i</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fake xhr</p></div></div><div class="code"><div class="wrapper">      <span class="nx">jqXHR</span> <span class="o">=</span> <span class="p">{</span>

        <span class="nx">readyState</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Caches the header</p></div></div><div class="code"><div class="wrapper">        <span class="nx">setRequestHeader</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">lname</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
            <span class="nx">name</span> <span class="o">=</span> <span class="nx">requestHeadersNames</span><span class="p">[</span> <span class="nx">lname</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">requestHeadersNames</span><span class="p">[</span> <span class="nx">lname</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">name</span><span class="p">;</span>
            <span class="nx">requestHeaders</span><span class="p">[</span> <span class="nx">name</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Raw string</p></div></div><div class="code"><div class="wrapper">        <span class="nx">getAllResponseHeaders</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">state</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">responseHeadersString</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Builds headers hashtable if needed</p></div></div><div class="code"><div class="wrapper">        <span class="nx">getResponseHeader</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">match</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">responseHeaders</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">responseHeaders</span> <span class="o">=</span> <span class="p">{};</span>
              <span class="k">while</span><span class="p">(</span> <span class="p">(</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">rheaders</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">responseHeadersString</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">responseHeaders</span><span class="p">[</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span> <span class="mi">2</span> <span class="p">];</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">match</span> <span class="o">=</span> <span class="nx">responseHeaders</span><span class="p">[</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="p">];</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">match</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">match</span><span class="p">;</span>
        <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Overrides response content-type header</p></div></div><div class="code"><div class="wrapper">        <span class="nx">overrideMimeType</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">state</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">s</span><span class="p">.</span><span class="nx">mimeType</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cancel the request</p></div></div><div class="code"><div class="wrapper">        <span class="nx">abort</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">statusText</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">statusText</span> <span class="o">=</span> <span class="nx">statusText</span> <span class="o">||</span> <span class="s2">&quot;abort&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">transport</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">transport</span><span class="p">.</span><span class="nx">abort</span><span class="p">(</span> <span class="nx">statusText</span> <span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">done</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">statusText</span> <span class="p">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Callback for when everything is done
It is defined here because jslint complains if it is declared
at the end of the function (which would be more logical and readable)</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span> <span class="nx">done</span><span class="p">(</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">responses</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Called once</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>State is "done" now</p></div></div><div class="code"><div class="wrapper">      <span class="nx">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clear timeout if it exists</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">timeoutTimer</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">clearTimeout</span><span class="p">(</span> <span class="nx">timeoutTimer</span> <span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Dereference transport for early garbage collection
(no matter how long the jqXHR object will be used)</p></div></div><div class="code"><div class="wrapper">      <span class="nx">transport</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cache response headers</p></div></div><div class="code"><div class="wrapper">      <span class="nx">responseHeadersString</span> <span class="o">=</span> <span class="nx">headers</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set readyState</p></div></div><div class="code"><div class="wrapper">      <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="nx">status</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">isSuccess</span><span class="p">,</span>
        <span class="nx">success</span><span class="p">,</span>
        <span class="nx">error</span><span class="p">,</span>
        <span class="nx">response</span> <span class="o">=</span> <span class="nx">responses</span> <span class="o">?</span> <span class="nx">ajaxHandleResponses</span><span class="p">(</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">responses</span> <span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
        <span class="nx">lastModified</span><span class="p">,</span>
        <span class="nx">etag</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If successful, handle type chaining</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">status</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="o">||</span> <span class="nx">status</span> <span class="o">===</span> <span class="mi">304</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ifModified</span> <span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">lastModified</span> <span class="o">=</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span> <span class="s2">&quot;Last-Modified&quot;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">jQuery</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">[</span> <span class="nx">ifModifiedKey</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">lastModified</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">etag</span> <span class="o">=</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span> <span class="s2">&quot;Etag&quot;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">jQuery</span><span class="p">.</span><span class="nx">etag</span><span class="p">[</span> <span class="nx">ifModifiedKey</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">etag</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If not modified</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span> <span class="nx">status</span> <span class="o">===</span> <span class="mi">304</span> <span class="p">)</span> <span class="p">{</span>

          <span class="nx">statusText</span> <span class="o">=</span> <span class="s2">&quot;notmodified&quot;</span><span class="p">;</span>
          <span class="nx">isSuccess</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we have data</p></div></div><div class="code"><div class="wrapper">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

          <span class="k">try</span> <span class="p">{</span>
            <span class="nx">success</span> <span class="o">=</span> <span class="nx">ajaxConvert</span><span class="p">(</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">response</span> <span class="p">);</span>
            <span class="nx">statusText</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span><span class="p">;</span>
            <span class="nx">isSuccess</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We have a parsererror</p></div></div><div class="code"><div class="wrapper">            <span class="nx">statusText</span> <span class="o">=</span> <span class="s2">&quot;parsererror&quot;</span><span class="p">;</span>
            <span class="nx">error</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We extract error from statusText
then normalize statusText and status for non-aborts</p></div></div><div class="code"><div class="wrapper">        <span class="nx">error</span> <span class="o">=</span> <span class="nx">statusText</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">statusText</span> <span class="o">||</span> <span class="nx">status</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">statusText</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set data for the fake xhr object</p></div></div><div class="code"><div class="wrapper">      <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
      <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">statusText</span> <span class="o">=</span> <span class="nx">statusText</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Success/Error</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">isSuccess</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolveWith</span><span class="p">(</span> <span class="nx">callbackContext</span><span class="p">,</span> <span class="p">[</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">rejectWith</span><span class="p">(</span> <span class="nx">callbackContext</span><span class="p">,</span> <span class="p">[</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">error</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Status-dependent callbacks</p></div></div><div class="code"><div class="wrapper">      <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">(</span> <span class="nx">statusCode</span> <span class="p">);</span>
      <span class="nx">statusCode</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">fireGlobals</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">globalEventContext</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s2">&quot;ajax&quot;</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">isSuccess</span> <span class="o">?</span> <span class="s2">&quot;Success&quot;</span> <span class="o">:</span> <span class="s2">&quot;Error&quot;</span> <span class="p">),</span>
            <span class="p">[</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">isSuccess</span> <span class="o">?</span> <span class="nx">success</span> <span class="o">:</span> <span class="nx">error</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Complete</p></div></div><div class="code"><div class="wrapper">      <span class="nx">completeDeferred</span><span class="p">.</span><span class="nx">resolveWith</span><span class="p">(</span> <span class="nx">callbackContext</span><span class="p">,</span> <span class="p">[</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">statusText</span> <span class="p">]</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">fireGlobals</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">globalEventContext</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s2">&quot;ajaxComplete&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">s</span><span class="p">]</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle the global AJAX counter</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="o">--</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">active</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">jQuery</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s2">&quot;ajaxStop&quot;</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Attach deferreds</p></div></div><div class="code"><div class="wrapper">    <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">(</span> <span class="nx">jqXHR</span> <span class="p">);</span>
    <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">success</span> <span class="o">=</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span>
    <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">fail</span><span class="p">;</span>
    <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">complete</span> <span class="o">=</span> <span class="nx">completeDeferred</span><span class="p">.</span><span class="nx">done</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Status-dependent callbacks</p></div></div><div class="code"><div class="wrapper">    <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tmp</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span><span class="p">(</span> <span class="nx">tmp</span> <span class="k">in</span> <span class="nx">map</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">statusCode</span><span class="p">[</span> <span class="nx">tmp</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">statusCode</span><span class="p">[</span><span class="nx">tmp</span><span class="p">],</span> <span class="nx">map</span><span class="p">[</span><span class="nx">tmp</span><span class="p">]</span> <span class="p">];</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">map</span><span class="p">[</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">status</span> <span class="p">];</span>
          <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="nx">tmp</span><span class="p">,</span> <span class="nx">tmp</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove hash character (#7531: and string promotion)
Add protocol if not provided (#5866: IE7 issue with protocol-less urls)
We also use the url parameter if available</p></div></div><div class="code"><div class="wrapper">    <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">url</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="p">).</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">rhash</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">).</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">rprotocol</span><span class="p">,</span> <span class="nx">ajaxLocParts</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;//&quot;</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Extract dataTypes list</p></div></div><div class="code"><div class="wrapper">    <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataType</span> <span class="o">||</span> <span class="s2">&quot;*&quot;</span> <span class="p">).</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span> <span class="nx">rspacesAjax</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine if a cross-domain request is in order</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="o">==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">parts</span> <span class="o">=</span> <span class="nx">rurl</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="p">);</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span> <span class="nx">parts</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span> <span class="nx">parts</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">!=</span> <span class="nx">ajaxLocParts</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">parts</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">!=</span> <span class="nx">ajaxLocParts</span><span class="p">[</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">||</span>
          <span class="p">(</span> <span class="nx">parts</span><span class="p">[</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">parts</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;http:&quot;</span> <span class="o">?</span> <span class="mi">80</span> <span class="o">:</span> <span class="mi">443</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span>
            <span class="p">(</span> <span class="nx">ajaxLocParts</span><span class="p">[</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">ajaxLocParts</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;http:&quot;</span> <span class="o">?</span> <span class="mi">80</span> <span class="o">:</span> <span class="mi">443</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
      <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Convert data if not already a string</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">processData</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">traditional</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply prefilters</p></div></div><div class="code"><div class="wrapper">    <span class="nx">inspectPrefiltersOrTransports</span><span class="p">(</span> <span class="nx">prefilters</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If request was aborted inside a prefiler, stop there</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We can fire global events as of now if asked to</p></div></div><div class="code"><div class="wrapper">    <span class="nx">fireGlobals</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">global</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Uppercase the type</p></div></div><div class="code"><div class="wrapper">    <span class="nx">s</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine if request has content</p></div></div><div class="code"><div class="wrapper">    <span class="nx">s</span><span class="p">.</span><span class="nx">hasContent</span> <span class="o">=</span> <span class="o">!</span><span class="nx">rnoContent</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">type</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Watch for a new set of requests</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">fireGlobals</span> <span class="o">&amp;&amp;</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">active</span><span class="o">++</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">jQuery</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s2">&quot;ajaxStart&quot;</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>More options handling for requests with no content</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">hasContent</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If data is available, append data to url</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="o">+=</span> <span class="p">(</span> <span class="nx">rquery</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">:</span> <span class="s2">&quot;?&quot;</span> <span class="p">)</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get ifModifiedKey before adding the anti-cache parameter</p></div></div><div class="code"><div class="wrapper">      <span class="nx">ifModifiedKey</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add anti-cache in url if needed</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">cache</span> <span class="o">===</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">ts</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>try replacing _= if it is there</p></div></div><div class="code"><div class="wrapper">          <span class="nx">ret</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">rts</span><span class="p">,</span> <span class="s2">&quot;$1_=&quot;</span> <span class="o">+</span> <span class="nx">ts</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if nothing was replaced, add timestamp to the end</p></div></div><div class="code"><div class="wrapper">        <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">ret</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="nx">ret</span> <span class="o">===</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="p">)</span> <span class="o">?</span> <span class="p">(</span> <span class="nx">rquery</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">:</span> <span class="s2">&quot;?&quot;</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_=&quot;</span> <span class="o">+</span> <span class="nx">ts</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the correct header, if data is being sent</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">hasContent</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">contentType</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">contentType</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ifModified</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">ifModifiedKey</span> <span class="o">=</span> <span class="nx">ifModifiedKey</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">[</span> <span class="nx">ifModifiedKey</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span> <span class="s2">&quot;If-Modified-Since&quot;</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">[</span> <span class="nx">ifModifiedKey</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">etag</span><span class="p">[</span> <span class="nx">ifModifiedKey</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span> <span class="s2">&quot;If-None-Match&quot;</span><span class="p">,</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">etag</span><span class="p">[</span> <span class="nx">ifModifiedKey</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set the Accepts header for the server, depending on the dataType</p></div></div><div class="code"><div class="wrapper">    <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span>
      <span class="s2">&quot;Accept&quot;</span><span class="p">,</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">accepts</span><span class="p">[</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="o">?</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">accepts</span><span class="p">[</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">!==</span> <span class="s2">&quot;*&quot;</span> <span class="o">?</span> <span class="s2">&quot;, */*; q=0.01&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">)</span> <span class="o">:</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">accepts</span><span class="p">[</span> <span class="s2">&quot;*&quot;</span> <span class="p">]</span>
    <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check for headers option</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">headers</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Allow custom headers/mimetypes and early abort</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">beforeSend</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">beforeSend</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="nx">callbackContext</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">s</span> <span class="p">)</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">state</span> <span class="o">===</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Abort if not done already</p></div></div><div class="code"><div class="wrapper">        <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install callbacks on deferreds</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">{</span> <span class="nx">success</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">complete</span><span class="o">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">jqXHR</span><span class="p">[</span> <span class="nx">i</span> <span class="p">](</span> <span class="nx">s</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="p">);</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get transport</p></div></div><div class="code"><div class="wrapper">    <span class="nx">transport</span> <span class="o">=</span> <span class="nx">inspectPrefiltersOrTransports</span><span class="p">(</span> <span class="nx">transports</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If no transport, we auto-abort</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">transport</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">done</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;No Transport&quot;</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Send global event</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">fireGlobals</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">globalEventContext</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span> <span class="s2">&quot;ajaxSend&quot;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">s</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Timeout</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">async</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">timeoutTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">abort</span><span class="p">(</span> <span class="s2">&quot;timeout&quot;</span> <span class="p">);</span>
        <span class="p">},</span> <span class="nx">s</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="nx">requestHeaders</span><span class="p">,</span> <span class="nx">done</span> <span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Propagate exception as error if not done</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span> <span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">done</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">e</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Simply rethrow otherwise</p></div></div><div class="code"><div class="wrapper">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">jQuery</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">jqXHR</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serialize an array of form elements or a set of
key/values into a query string</p></div></div><div class="code"><div class="wrapper">  <span class="nx">param</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">traditional</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If value is a function, invoke it and return its value</p></div></div><div class="code"><div class="wrapper">        <span class="nx">value</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">value</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">value</span><span class="p">()</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
        <span class="nx">s</span><span class="p">[</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span> <span class="nx">value</span> <span class="p">);</span>
      <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set traditional to true for jQuery &lt;= 1.3.2 behavior.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">traditional</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">traditional</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">traditional</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If an array was passed in, assume that it is an array of form elements.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">a</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">a</span><span class="p">.</span><span class="nx">jquery</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span> <span class="nx">a</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serialize the form elements</p></div></div><div class="code"><div class="wrapper">      <span class="nx">jQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">a</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">add</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="p">);</span>
      <span class="p">});</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If traditional, encode the "old" way (the way 1.3.2 or older
did it), otherwise encode params recursively.</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">prefix</span> <span class="k">in</span> <span class="nx">a</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">buildParams</span><span class="p">(</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span> <span class="nx">prefix</span> <span class="p">],</span> <span class="nx">traditional</span><span class="p">,</span> <span class="nx">add</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return the resulting serialization</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span> <span class="s2">&quot;&amp;&quot;</span> <span class="p">).</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">r20</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">buildParams</span><span class="p">(</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">traditional</span><span class="p">,</span> <span class="nx">add</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serialize array item.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">jQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">traditional</span> <span class="o">||</span> <span class="nx">rbracket</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">prefix</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Treat each array item as a scalar.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">add</span><span class="p">(</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">v</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If array item is non-scalar (array or object), encode its
numeric index to resolve deserialization ambiguity issues.
Note that rack (as of 1.0.0) can't currently deserialize
nested arrays properly, and attempting to do so may cause
a server error. Possible fixes are to modify rack's
deserialization algorithm or to provide an option or flag
to force array serialization to be shallow.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">buildParams</span><span class="p">(</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="o">||</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">?</span> <span class="nx">i</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span> <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">traditional</span><span class="p">,</span> <span class="nx">add</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>

  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">traditional</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serialize object item.</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">buildParams</span><span class="p">(</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">[</span> <span class="nx">name</span> <span class="p">],</span> <span class="nx">traditional</span><span class="p">,</span> <span class="nx">add</span> <span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Serialize scalar item.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">add</span><span class="p">(</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">obj</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This is still on the jQuery object... for now
Want to move this to jQuery.ajax some day</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Counter for holding the number of active queries</p></div></div><div class="code"><div class="wrapper">  <span class="nx">active</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Last-Modified header cache for next request</p></div></div><div class="code"><div class="wrapper">  <span class="nx">lastModified</span><span class="o">:</span> <span class="p">{},</span>
  <span class="nx">etag</span><span class="o">:</span> <span class="p">{}</span>

<span class="p">});</span>

<span class="cm">/* Handles responses to an ajax request:</span>
<span class="cm"> * - sets all responseXXX fields accordingly</span>
<span class="cm"> * - finds the right dataType (mediates between content-type and expected dataType)</span>
<span class="cm"> * - returns the corresponding response</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">ajaxHandleResponses</span><span class="p">(</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">responses</span> <span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">contents</span><span class="p">,</span>
    <span class="nx">dataTypes</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">,</span>
    <span class="nx">responseFields</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">responseFields</span><span class="p">,</span>
    <span class="nx">ct</span><span class="p">,</span>
    <span class="nx">type</span><span class="p">,</span>
    <span class="nx">finalDataType</span><span class="p">,</span>
    <span class="nx">firstDataType</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fill responseXXX fields</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span><span class="p">(</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">responseFields</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">responses</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">jqXHR</span><span class="p">[</span> <span class="nx">responseFields</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">responses</span><span class="p">[</span> <span class="nx">type</span> <span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove auto dataType and get content-type in the process</p></div></div><div class="code"><div class="wrapper">  <span class="k">while</span><span class="p">(</span> <span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;*&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">dataTypes</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">ct</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">ct</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mimeType</span> <span class="o">||</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span> <span class="s2">&quot;content-type&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check if we're dealing with a known content-type</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">ct</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">contents</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">contents</span><span class="p">[</span> <span class="nx">type</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">contents</span><span class="p">[</span> <span class="nx">type</span> <span class="p">].</span><span class="nx">test</span><span class="p">(</span> <span class="nx">ct</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">dataTypes</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">type</span> <span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Check to see if we have a response for the expected dataType</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="k">in</span> <span class="nx">responses</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">finalDataType</span> <span class="o">=</span> <span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Try convertible dataTypes</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="p">(</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">responses</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">converters</span><span class="p">[</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">dataTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">finalDataType</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">firstDataType</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">firstDataType</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Or just use first one</p></div></div><div class="code"><div class="wrapper">    <span class="nx">finalDataType</span> <span class="o">=</span> <span class="nx">finalDataType</span> <span class="o">||</span> <span class="nx">firstDataType</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we found a dataType
We add the dataType to the list if needed
and return the corresponding response</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">finalDataType</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">finalDataType</span> <span class="o">!==</span> <span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">dataTypes</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span> <span class="nx">finalDataType</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">responses</span><span class="p">[</span> <span class="nx">finalDataType</span> <span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Chain conversions given the request and the original response</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">ajaxConvert</span><span class="p">(</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply the dataFilter if provided</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataFilter</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">response</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataFilter</span><span class="p">(</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataType</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">dataTypes</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">,</span>
    <span class="nx">converters</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">i</span><span class="p">,</span>
    <span class="nx">key</span><span class="p">,</span>
    <span class="nx">length</span> <span class="o">=</span> <span class="nx">dataTypes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="nx">tmp</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Current and previous dataTypes</p></div></div><div class="code"><div class="wrapper">    <span class="nx">current</span> <span class="o">=</span> <span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">],</span>
    <span class="nx">prev</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Conversion expression</p></div></div><div class="code"><div class="wrapper">    <span class="nx">conversion</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Conversion function</p></div></div><div class="code"><div class="wrapper">    <span class="nx">conv</span><span class="p">,</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Conversion functions (transitive conversion)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">conv1</span><span class="p">,</span>
    <span class="nx">conv2</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For each dataType in the chain</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span><span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create converters map
with lowercased keys</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">converters</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">converters</span><span class="p">[</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">converters</span><span class="p">[</span> <span class="nx">key</span> <span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the dataTypes</p></div></div><div class="code"><div class="wrapper">    <span class="nx">prev</span> <span class="o">=</span> <span class="nx">current</span><span class="p">;</span>
    <span class="nx">current</span> <span class="o">=</span> <span class="nx">dataTypes</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If current is auto dataType, update it to prev</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span><span class="p">(</span> <span class="nx">current</span> <span class="o">===</span> <span class="s2">&quot;*&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">current</span> <span class="o">=</span> <span class="nx">prev</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If no auto and dataTypes are actually different</p></div></div><div class="code"><div class="wrapper">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">prev</span> <span class="o">!==</span> <span class="s2">&quot;*&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">prev</span> <span class="o">!==</span> <span class="nx">current</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get the converter</p></div></div><div class="code"><div class="wrapper">      <span class="nx">conversion</span> <span class="o">=</span> <span class="nx">prev</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">current</span><span class="p">;</span>
      <span class="nx">conv</span> <span class="o">=</span> <span class="nx">converters</span><span class="p">[</span> <span class="nx">conversion</span> <span class="p">]</span> <span class="o">||</span> <span class="nx">converters</span><span class="p">[</span> <span class="s2">&quot;* &quot;</span> <span class="o">+</span> <span class="nx">current</span> <span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If there is no direct converter, search transitively</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">conv</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">conv2</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span> <span class="nx">conv1</span> <span class="k">in</span> <span class="nx">converters</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">conv1</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="s2">&quot; &quot;</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">tmp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">===</span> <span class="nx">prev</span> <span class="o">||</span> <span class="nx">tmp</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;*&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">conv2</span> <span class="o">=</span> <span class="nx">converters</span><span class="p">[</span> <span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">current</span> <span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">conv2</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">conv1</span> <span class="o">=</span> <span class="nx">converters</span><span class="p">[</span> <span class="nx">conv1</span> <span class="p">];</span>
              <span class="k">if</span> <span class="p">(</span> <span class="nx">conv1</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">conv</span> <span class="o">=</span> <span class="nx">conv2</span><span class="p">;</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">conv2</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">conv</span> <span class="o">=</span> <span class="nx">conv1</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we found no converter, dispatch an error</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">conv</span> <span class="o">||</span> <span class="nx">conv2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">jQuery</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="s2">&quot;No conversion from &quot;</span> <span class="o">+</span> <span class="nx">conversion</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot; to &quot;</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If found converter is not an equivalence</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">conv</span> <span class="o">!==</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Convert with 1 or 2 converters accordingly</p></div></div><div class="code"><div class="wrapper">        <span class="nx">response</span> <span class="o">=</span> <span class="nx">conv</span> <span class="o">?</span> <span class="nx">conv</span><span class="p">(</span> <span class="nx">response</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">conv2</span><span class="p">(</span> <span class="nx">conv1</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>




<span class="kd">var</span> <span class="nx">jsc</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
  <span class="nx">jsre</span> <span class="o">=</span> <span class="sr">/(\=)\?(&amp;|$)|\?\?/i</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default jsonp settings</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
  <span class="nx">jsonp</span><span class="o">:</span> <span class="s2">&quot;callback&quot;</span><span class="p">,</span>
  <span class="nx">jsonpCallback</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">expando</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">jsc</span><span class="o">++</span> <span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Detect, normalize options and install callbacks for jsonp requests</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxPrefilter</span><span class="p">(</span> <span class="s2">&quot;json jsonp&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">originalSettings</span><span class="p">,</span> <span class="nx">jqXHR</span> <span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">inspectData</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">===</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span> <span class="k">typeof</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">===</span> <span class="s2">&quot;jsonp&quot;</span> <span class="o">||</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">jsonp</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">jsre</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="p">)</span> <span class="o">||</span>
        <span class="nx">inspectData</span> <span class="o">&amp;&amp;</span> <span class="nx">jsre</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">responseContainer</span><span class="p">,</span>
      <span class="nx">jsonpCallback</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">jsonpCallback</span> <span class="o">=</span>
        <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">jsonpCallback</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">s</span><span class="p">.</span><span class="nx">jsonpCallback</span><span class="p">()</span> <span class="o">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">jsonpCallback</span><span class="p">,</span>
      <span class="nx">previous</span> <span class="o">=</span> <span class="nb">window</span><span class="p">[</span> <span class="nx">jsonpCallback</span> <span class="p">],</span>
      <span class="nx">url</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
      <span class="nx">replace</span> <span class="o">=</span> <span class="s2">&quot;$1&quot;</span> <span class="o">+</span> <span class="nx">jsonpCallback</span> <span class="o">+</span> <span class="s2">&quot;$2&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">jsonp</span> <span class="o">!==</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">jsre</span><span class="p">,</span> <span class="nx">replace</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="o">===</span> <span class="nx">url</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">inspectData</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">jsre</span><span class="p">,</span> <span class="nx">replace</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add callback manually</p></div></div><div class="code"><div class="wrapper">          <span class="nx">url</span> <span class="o">+=</span> <span class="p">(</span><span class="sr">/\?/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">url</span> <span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">:</span> <span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">jsonp</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nx">jsonpCallback</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">s</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install callback</p></div></div><div class="code"><div class="wrapper">    <span class="nb">window</span><span class="p">[</span> <span class="nx">jsonpCallback</span> <span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">response</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">responseContainer</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">response</span> <span class="p">];</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Clean-up function</p></div></div><div class="code"><div class="wrapper">    <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">always</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set callback back to previous value</p></div></div><div class="code"><div class="wrapper">      <span class="nb">window</span><span class="p">[</span> <span class="nx">jsonpCallback</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">previous</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call if it was a function and we have a response</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">responseContainer</span> <span class="o">&amp;&amp;</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">previous</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">[</span> <span class="nx">jsonpCallback</span> <span class="p">](</span> <span class="nx">responseContainer</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use data converter to retrieve json after script execution</p></div></div><div class="code"><div class="wrapper">    <span class="nx">s</span><span class="p">.</span><span class="nx">converters</span><span class="p">[</span><span class="s2">&quot;script json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">responseContainer</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">jQuery</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="nx">jsonpCallback</span> <span class="o">+</span> <span class="s2">&quot; was not called&quot;</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">responseContainer</span><span class="p">[</span> <span class="mi">0</span> <span class="p">];</span>
    <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>force json dataType</p></div></div><div class="code"><div class="wrapper">    <span class="nx">s</span><span class="p">.</span><span class="nx">dataTypes</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Delegate to script</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="s2">&quot;script&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Install script dataType</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSetup</span><span class="p">({</span>
  <span class="nx">accepts</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">script</span><span class="o">:</span> <span class="s2">&quot;text/javascript, application/javascript, application/ecmascript, application/x-ecmascript&quot;</span>
  <span class="p">},</span>
  <span class="nx">contents</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">script</span><span class="o">:</span> <span class="sr">/javascript|ecmascript/</span>
  <span class="p">},</span>
  <span class="nx">converters</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;text script&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">text</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">jQuery</span><span class="p">.</span><span class="nx">globalEval</span><span class="p">(</span> <span class="nx">text</span> <span class="p">);</span>
      <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle cache's special case and global</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxPrefilter</span><span class="p">(</span> <span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">cache</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">global</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Bind script tag hack transport</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxTransport</span><span class="p">(</span> <span class="s2">&quot;script&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This transport only deals with cross domain requests</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">script</span><span class="p">,</span>
      <span class="nx">head</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">head</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span> <span class="s2">&quot;head&quot;</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">{</span>

      <span class="nx">send</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span> <span class="s2">&quot;script&quot;</span> <span class="p">);</span>

        <span class="nx">script</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="s2">&quot;async&quot;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">scriptCharset</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">script</span><span class="p">.</span><span class="nx">charset</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">scriptCharset</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Attach handlers for all browsers</p></div></div><div class="code"><div class="wrapper">        <span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">isAbort</span> <span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">isAbort</span> <span class="o">||</span> <span class="o">!</span><span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="sr">/loaded|complete/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">script</span><span class="p">.</span><span class="nx">readyState</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Handle memory leak in IE</p></div></div><div class="code"><div class="wrapper">            <span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove the script</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span> <span class="nx">head</span> <span class="o">&amp;&amp;</span> <span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">head</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span> <span class="nx">script</span> <span class="p">);</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Dereference the script</p></div></div><div class="code"><div class="wrapper">            <span class="nx">script</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Callback if not abort</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isAbort</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">callback</span><span class="p">(</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Use insertBefore instead of appendChild  to circumvent an IE6 bug.
This arises when a base node is used (#2709 and #4378).</p></div></div><div class="code"><div class="wrapper">        <span class="nx">head</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span> <span class="nx">script</span><span class="p">,</span> <span class="nx">head</span><span class="p">.</span><span class="nx">firstChild</span> <span class="p">);</span>
      <span class="p">},</span>

      <span class="nx">abort</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">script</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">script</span><span class="p">.</span><span class="nx">onload</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">});</span>




<span class="kd">var</span> <span class="c1">// #5280: Internet Explorer will keep connections alive if we don&#39;t abort on unload</span>
  <span class="nx">xhrOnUnloadAbort</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span> <span class="o">?</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Abort all pending requests</p></div></div><div class="code"><div class="wrapper">    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">xhrCallbacks</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">xhrCallbacks</span><span class="p">[</span> <span class="nx">key</span> <span class="p">](</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">xhrId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">xhrCallbacks</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Functions to create xhrs</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">createStandardXHR</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createActiveXHR</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">(</span> <span class="s2">&quot;Microsoft.XMLHTTP&quot;</span> <span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the request object
(This is still attached to ajaxSettings for backward compatibility)</p></div></div><div class="code"><div class="wrapper"><span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span> <span class="o">?</span>
  <span class="cm">/* Microsoft failed to properly</span>
<span class="cm">   * implement the XMLHttpRequest in IE7 (can&#39;t request local files),</span>
<span class="cm">   * so we use the ActiveXObject when it is available</span>
<span class="cm">   * Additionally XMLHttpRequest can be disabled in IE7/IE8 so</span>
<span class="cm">   * we need a fallback.</span>
<span class="cm">   */</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isLocal</span> <span class="o">&amp;&amp;</span> <span class="nx">createStandardXHR</span><span class="p">()</span> <span class="o">||</span> <span class="nx">createActiveXHR</span><span class="p">();</span>
  <span class="p">}</span> <span class="o">:</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For all other browsers, use the standard XMLHttpRequest object</p></div></div><div class="code"><div class="wrapper">  <span class="nx">createStandardXHR</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Determine support properties</p></div></div><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">xhr</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">support</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">ajax</span><span class="o">:</span> <span class="o">!!</span><span class="nx">xhr</span><span class="p">,</span>
    <span class="nx">cors</span><span class="o">:</span> <span class="o">!!</span><span class="nx">xhr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="s2">&quot;withCredentials&quot;</span> <span class="k">in</span> <span class="nx">xhr</span> <span class="p">)</span>
  <span class="p">});</span>
<span class="p">})(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxSettings</span><span class="p">.</span><span class="nx">xhr</span><span class="p">()</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create transport if the browser can provide an xhr</p></div></div><div class="code"><div class="wrapper"><span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">support</span><span class="p">.</span><span class="nx">ajax</span> <span class="p">)</span> <span class="p">{</span>

  <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajaxTransport</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span> <span class="nx">s</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Cross domain only allowed if supported through XMLHttpRequest</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="o">||</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">support</span><span class="p">.</span><span class="nx">cors</span> <span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">callback</span><span class="p">;</span>

      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">send</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">complete</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Get a new xhr</p></div></div><div class="code"><div class="wrapper">          <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">xhr</span><span class="p">(),</span>
            <span class="nx">handle</span><span class="p">,</span>
            <span class="nx">i</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Open the socket
Passing null username, generates a login popup on Opera (#2865)</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">username</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">async</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">password</span> <span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">async</span> <span class="p">);</span>
          <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Apply custom fields if provided</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">xhrFields</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">xhrFields</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">xhr</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">xhrFields</span><span class="p">[</span> <span class="nx">i</span> <span class="p">];</span>
            <span class="p">}</span>
          <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Override mime type if needed</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mimeType</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">overrideMimeType</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mimeType</span> <span class="p">);</span>
          <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>X-Requested-With header
For cross-domain requests, seeing as conditions for a preflight are
akin to a jigsaw puzzle, we simply never set it to be sure.
(it can always be set on a per-request basis or even using ajaxSetup)
For same-domain requests, won't change header if already provided.</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">headers</span><span class="p">[</span><span class="s2">&quot;X-Requested-With&quot;</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">headers</span><span class="p">[</span> <span class="s2">&quot;X-Requested-With&quot;</span> <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;XMLHttpRequest&quot;</span><span class="p">;</span>
          <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Need an extra try/catch for cross domain requests in Firefox 3</p></div></div><div class="code"><div class="wrapper">          <span class="k">try</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">headers</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">headers</span><span class="p">[</span> <span class="nx">i</span> <span class="p">]</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">_</span> <span class="p">)</span> <span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Do send the request
This may raise an exception which is actually
handled in jQuery.ajax (so no try/catch here)</p></div></div><div class="code"><div class="wrapper">          <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span> <span class="p">(</span> <span class="nx">s</span><span class="p">.</span><span class="nx">hasContent</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">data</span> <span class="p">)</span> <span class="o">||</span> <span class="kc">null</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Listener</p></div></div><div class="code"><div class="wrapper">          <span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">isAbort</span> <span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">status</span><span class="p">,</span>
              <span class="nx">statusText</span><span class="p">,</span>
              <span class="nx">responseHeaders</span><span class="p">,</span>
              <span class="nx">responses</span><span class="p">,</span>
              <span class="nx">xml</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Firefox throws exceptions when accessing properties
of an xhr when a network error occured
http://helpful.knobs-dials.com/index.php/Component<em>returned</em>failure<em>code:</em>0x80040111<em>(NS</em>ERROR<em>NOT</em>AVAILABLE)</p></div></div><div class="code"><div class="wrapper">            <span class="k">try</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Was never called and is aborted or complete</p></div></div><div class="code"><div class="wrapper">              <span class="k">if</span> <span class="p">(</span> <span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">isAbort</span> <span class="o">||</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Only called once</p></div></div><div class="code"><div class="wrapper">                <span class="nx">callback</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Do not keep as active anymore</p></div></div><div class="code"><div class="wrapper">                <span class="k">if</span> <span class="p">(</span> <span class="nx">handle</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">noop</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="nx">xhrOnUnloadAbort</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="k">delete</span> <span class="nx">xhrCallbacks</span><span class="p">[</span> <span class="nx">handle</span> <span class="p">];</span>
                  <span class="p">}</span>
                <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If it's an abort</p></div></div><div class="code"><div class="wrapper">                <span class="k">if</span> <span class="p">(</span> <span class="nx">isAbort</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Abort it manually if needed</p></div></div><div class="code"><div class="wrapper">                  <span class="k">if</span> <span class="p">(</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
                  <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">status</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
                  <span class="nx">responseHeaders</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">getAllResponseHeaders</span><span class="p">();</span>
                  <span class="nx">responses</span> <span class="o">=</span> <span class="p">{};</span>
                  <span class="nx">xml</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Construct response list</p></div></div><div class="code"><div class="wrapper">                  <span class="k">if</span> <span class="p">(</span> <span class="nx">xml</span> <span class="o">&amp;&amp;</span> <span class="nx">xml</span><span class="p">.</span><span class="nx">documentElement</span> <span class="cm">/* #4958 */</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">responses</span><span class="p">.</span><span class="nx">xml</span> <span class="o">=</span> <span class="nx">xml</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="nx">responses</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Firefox throws an exception when accessing
statusText for faulty cross-domain requests</p></div></div><div class="code"><div class="wrapper">                  <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">statusText</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">statusText</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We normalize with Webkit giving an empty statusText</p></div></div><div class="code"><div class="wrapper">                    <span class="nx">statusText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                  <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Filter status for non standard behaviors</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the request is local and we have data: assume a success
(success with no data won't get notified, that's the best we
can do given current implementations)</p></div></div><div class="code"><div class="wrapper">                  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">status</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">isLocal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">crossDomain</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">status</span> <span class="o">=</span> <span class="nx">responses</span><span class="p">.</span><span class="nx">text</span> <span class="o">?</span> <span class="mi">200</span> <span class="o">:</span> <span class="mi">404</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>IE - #1450: sometimes returns 1223 when it should be 204</p></div></div><div class="code"><div class="wrapper">                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">status</span> <span class="o">===</span> <span class="mi">1223</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">status</span> <span class="o">=</span> <span class="mi">204</span><span class="p">;</span>
                  <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">firefoxAccessException</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">isAbort</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">complete</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">firefoxAccessException</span> <span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Call complete if needed</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span> <span class="nx">responses</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">complete</span><span class="p">(</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">statusText</span><span class="p">,</span> <span class="nx">responses</span><span class="p">,</span> <span class="nx">responseHeaders</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if we're in sync mode or it's in cache
and has been retrieved directly (IE6 &amp; IE7)
we need to manually fire the callback</p></div></div><div class="code"><div class="wrapper">          <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">async</span> <span class="o">||</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">();</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">handle</span> <span class="o">=</span> <span class="o">++</span><span class="nx">xhrId</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">xhrOnUnloadAbort</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Create the active xhrs callbacks list if needed
and attach the unload handler</p></div></div><div class="code"><div class="wrapper">              <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">xhrCallbacks</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">xhrCallbacks</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="nx">jQuery</span><span class="p">(</span> <span class="nb">window</span> <span class="p">).</span><span class="nx">unload</span><span class="p">(</span> <span class="nx">xhrOnUnloadAbort</span> <span class="p">);</span>
              <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add to list of active xhrs callbacks</p></div></div><div class="code"><div class="wrapper">              <span class="nx">xhrCallbacks</span><span class="p">[</span> <span class="nx">handle</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">},</span>

        <span class="nx">abort</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">callback</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></div></div></div></div></body></html>